<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Question Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
      window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
      body { font-family: "Segoe UI", Arial, sans-serif; margin: 1.2rem; }
      form { max-width: 1200px; }
      label { display: block; margin-top: 0.8rem; font-weight: 600; }
      input, textarea, select { width: 100%; box-sizing: border-box; padding: 0.5rem; }
      textarea { min-height: 120px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.8rem; }
      .card { border: 1px solid #ddd; border-radius: 6px; padding: 0.8rem; margin-top: 0.8rem; }
      .preview { background: #fafafa; max-height: 360px; overflow: auto; }
      .thumb { max-width: 180px; max-height: 140px; border: 1px solid #ccc; margin-right: 0.6rem; margin-top: 0.5rem; }
      .figure-card { display: inline-block; margin-right: 0.5rem; }
      .help { color: #444; font-size: 0.95rem; }
      .status { margin-top: 0.5rem; min-height: 1.2rem; font-size: 0.95rem; }
      .good { color: #0a6; }
      .warn { color: #c50; }
      .btn { padding: 0.45rem 0.8rem; margin-top: 0.45rem; margin-right: 0.45rem; }
      .actions { margin-top: 1rem; }
      .modal {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.72);
        align-items: center;
        justify-content: center;
      }
      .modal img { max-width: 92vw; max-height: 92vh; border: 2px solid #fff; background: #fff; }
      .preview-item { margin: 0.3rem 0; }
      .preview-rationale { color: #555; font-size: 0.9rem; margin-left: 1.2rem; }
      .prompt-preview-body { background: #fff; max-width: 860px; width: 92vw; max-height: 88vh; overflow: auto; border-radius: 6px; padding: 1rem; }
      .prompt-preview-body pre { white-space: pre-wrap; word-break: break-word; background: #f7f7f7; padding: 0.6rem; border-radius: 4px; border: 1px solid #ddd; }
      .mc-guidance { min-height: 60px; }
      @media (max-width: 900px) {
        .row, .row3 { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <h1>{{ "Edit Question" if question else "New Question" }}</h1>
    <p><a href="/">Back to list</a></p>

    <form method="post" action="/questions/save" id="question-form">
      <div class="row3">
        <div>
          <label>Question ID</label>
          <input name="question_id" id="question_id" value="{{ question.id if question else '' }}" required />
        </div>
        <div>
          <label>Type</label>
          <select name="question_type" id="question_type">
            <option value="free_response" {% if question and question.question_type.value=="free_response" %}selected{% endif %}>Free Response</option>
            <option value="multiple_choice" {% if question and question.question_type.value=="multiple_choice" %}selected{% endif %}>Multiple Choice</option>
          </select>
        </div>
        <div>
          <label>Points</label>
          <input name="points" id="points" type="number" min="0" value="{{ question.points if question else 5 }}" />
        </div>
      </div>

      <label>Title (optional)</label>
      <input name="title" id="title" value="{{ question.title if question else '' }}" />
      <button type="button" class="btn" id="btn_ai_title">Generate Title</button>
      <button type="button" class="btn" id="btn_preview_title">Preview Prompt</button>
      <button type="button" class="btn" id="btn_undo_title">Undo</button>

      <div class="row">
        <div class="card">
          <label>Question Text (Markdown + math)</label>
          <textarea name="prompt_md" id="prompt_md">{{ question.prompt_md if question else '' }}</textarea>
          <button type="button" class="btn" id="btn_ai_prompt">Improve Text</button>
          <button type="button" class="btn" id="btn_preview_prompt">Preview Prompt</button>
          <button type="button" class="btn" id="btn_undo_prompt">Undo</button>
        </div>
        <div class="card preview">
          <strong>Question Preview</strong>
          <div id="prompt_preview"></div>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <label>Worked Solution (Markdown)</label>
          <textarea name="solution_md" id="solution_md">{{ question.solution.worked_solution_md if question else '' }}</textarea>
          <button type="button" class="btn" id="btn_ai_solution">Improve Solution</button>
          <button type="button" class="btn" id="btn_preview_solution">Preview Prompt</button>
          <button type="button" class="btn" id="btn_undo_solution">Undo</button>
        </div>
        <div class="card preview">
          <strong>Solution Preview</strong>
          <div id="solution_preview"></div>
        </div>
      </div>

      <div id="mc_block" class="card">
        <label>MC Options YAML (A-E)</label>
        <textarea name="choices_yaml" id="choices_yaml">{{ choices_yaml }}</textarea>
        <label>MC Generation Guidance (optional)</label>
        <textarea
          name="mc_options_guidance"
          id="mc_options_guidance"
          class="mc-guidance"
          placeholder="Please enter text to provide model further instructions for generating or improving the MC options and distractions"
        >{{ question.mc_options_guidance if question else '' }}</textarea>
        <button type="button" class="btn" id="btn_ai_mc">Generate MC A-E</button>
        <button type="button" class="btn" id="btn_preview_mc">Preview Prompt</button>
        <button type="button" class="btn" id="btn_undo_choices">Undo</button>
        <div class="row">
          <div class="card preview">
            <strong>MC Preview (Answers)</strong>
            <div id="mc_preview_answers"></div>
          </div>
          <div class="card preview">
            <strong>MC Preview (Answers + Rationale)</strong>
            <div id="mc_preview_rationale"></div>
          </div>
        </div>
      </div>

      <label>Checker Python Code</label>
      <textarea name="checker_code" id="checker_code">{{ question.checker.python_code if question else '' }}</textarea>

      <div class="card" id="figures_section">
        <label>Figures</label>
        <input type="hidden" id="figures_json" name="figures_json" value='{{ figures_json }}' />
        <p class="help">Paste copied image (`Ctrl+V` / `Cmd+V`) anywhere on this page. Each image is embedded directly in YAML.</p>
        <div id="figures_preview"></div>
        <button type="button" class="btn" id="btn_undo_figures">Undo Figure Change</button>
      </div>

      <div class="actions">
        <button type="submit" class="btn">Save and Return</button>
        <span id="save_status" class="status"></span>
      </div>
    </form>
    <div id="image_modal" class="modal">
      <img id="image_modal_img" alt="Expanded figure" />
    </div>
    <div id="prompt_preview_modal" class="modal">
      <div class="prompt-preview-body">
        <h3 id="prompt_preview_title"></h3>
        <h4>System Prompt</h4>
        <pre id="prompt_preview_system"></pre>
        <h4>User Prompt</h4>
        <pre id="prompt_preview_user"></pre>
        <h4>Figures Sent</h4>
        <pre id="prompt_preview_figures"></pre>
        <button type="button" class="btn" id="btn_close_prompt_preview">Close</button>
      </div>
    </div>

    <script>
      const form = document.getElementById("question-form");
      const saveStatus = document.getElementById("save_status");
      const questionIdEl = document.getElementById("question_id");
      const questionTypeEl = document.getElementById("question_type");
      const titleEl = document.getElementById("title");
      const pointsEl = document.getElementById("points");
      const promptEl = document.getElementById("prompt_md");
      const choicesEl = document.getElementById("choices_yaml");
      const mcGuidanceEl = document.getElementById("mc_options_guidance");
      const solutionEl = document.getElementById("solution_md");
      const checkerEl = document.getElementById("checker_code");
      const figuresInput = document.getElementById("figures_json");
      const figuresPreview = document.getElementById("figures_preview");
      const promptPreview = document.getElementById("prompt_preview");
      const solutionPreview = document.getElementById("solution_preview");
      const mcBlock = document.getElementById("mc_block");
      const mcPreviewAnswers = document.getElementById("mc_preview_answers");
      const mcPreviewRationale = document.getElementById("mc_preview_rationale");
      const imageModal = document.getElementById("image_modal");
      const imageModalImg = document.getElementById("image_modal_img");
      const promptPreviewModal = document.getElementById("prompt_preview_modal");
      const promptPreviewTitle = document.getElementById("prompt_preview_title");
      const promptPreviewSystem = document.getElementById("prompt_preview_system");
      const promptPreviewUser = document.getElementById("prompt_preview_user");
      const promptPreviewFigures = document.getElementById("prompt_preview_figures");
      const defaultChoicesYaml = `- label: A
  content_md: ''
  is_correct: true
- label: B
  content_md: ''
  is_correct: false
- label: C
  content_md: ''
  is_correct: false
- label: D
  content_md: ''
  is_correct: false
- label: E
  content_md: ''
  is_correct: false
`;

      let autosaveTimer = null;
      const undoStacks = { title: [], prompt: [], solution: [], choices: [], figures: [] };

      function pushUndo(section, value) {
        undoStacks[section].push(value);
        if (undoStacks[section].length > 20) undoStacks[section].shift();
      }

      function undo(section, setter) {
        const prev = undoStacks[section].pop();
        if (prev !== undefined) {
          setter(prev);
          scheduleAutosave();
        }
      }

      function setStatus(text, cls) {
        saveStatus.textContent = text;
        saveStatus.className = `status ${cls || ""}`;
      }

      function scientificNotationNormalize(text) {
        return text.replace(/(\d+(?:\.\d+)?)\s*[xX]\s*10\s*-\s*(\d+)/g, "$1 \\\\times 10^{-$2}");
      }

      function normalizeMathDelimitersForPreview(text) {
        return (text || "")
          .replace(/\\\[(.*?)\\\]/gs, (_, inner) => `$$${inner}$$`)
          .replace(/\\\((.*?)\\\)/gs, (_, inner) => `$${inner}$`);
      }

      function renderMarkdown() {
        promptPreview.innerHTML = marked.parse(normalizeMathDelimitersForPreview(promptEl.value));
        solutionPreview.innerHTML = marked.parse(normalizeMathDelimitersForPreview(solutionEl.value));
        if (window.MathJax && window.MathJax.typesetPromise) {
          window.MathJax.typesetPromise([promptPreview, solutionPreview]);
        }
      }

      function renderMCPreviews() {
        if (!isMC()) {
          mcPreviewAnswers.innerHTML = "";
          mcPreviewRationale.innerHTML = "";
          return;
        }
        let choices = [];
        try {
          choices = jsyaml.load(choicesEl.value) || [];
        } catch {
          mcPreviewAnswers.innerHTML = "<em>Invalid YAML</em>";
          mcPreviewRationale.innerHTML = "<em>Invalid YAML</em>";
          return;
        }
        choices = choices.slice().sort((a, b) => String(a.label || "").localeCompare(String(b.label || "")));
        mcPreviewAnswers.innerHTML = choices.map((c) => {
          const content = marked.parseInline(normalizeMathDelimitersForPreview(String(c.content_md || "")));
          return `<div class="preview-item"><strong>${c.label || "?"}.</strong> ${content}</div>`;
        }).join("");
        mcPreviewRationale.innerHTML = choices.map((c) => {
          const content = marked.parseInline(normalizeMathDelimitersForPreview(String(c.content_md || "")));
          const rationaleText = c.rationale
            ? marked.parseInline(normalizeMathDelimitersForPreview(String(c.rationale)))
            : "";
          const isCorrect = Boolean(c.is_correct);
          const answerLine = isCorrect
            ? `<strong>${c.label || "?"}. ${content}</strong>`
            : `<span>${c.label || "?"}. ${content}</span>`;
          const rationale = c.rationale ? `<div class="preview-rationale">Rationale: ${rationaleText}</div>` : "";
          return `<div class="preview-item">${answerLine}${rationale}</div>`;
        }).join("");
        if (window.MathJax && window.MathJax.typesetPromise) {
          window.MathJax.typesetPromise([mcPreviewAnswers, mcPreviewRationale]);
        }
      }

      function isMC() {
        return questionTypeEl.value === "multiple_choice";
      }

      function updateMCVisibility() {
        if (isMC() && !(choicesEl.value || "").trim()) {
          choicesEl.value = defaultChoicesYaml;
        }
        mcBlock.style.display = isMC() ? "block" : "none";
        renderMCPreviews();
      }

      function serializePayload() {
        return {
          title: titleEl.value,
          question_type: questionTypeEl.value,
          prompt_md: promptEl.value,
          mc_options_guidance: mcGuidanceEl.value,
          choices_yaml: choicesEl.value,
          solution_md: solutionEl.value,
          checker_code: checkerEl.value,
          figures_json: figuresInput.value || "[]",
          points: Number(pointsEl.value || 5),
        };
      }

      async function autosaveNow() {
        const qid = questionIdEl.value.trim();
        if (!qid) return;
        setStatus("Saving...", "warn");
        const res = await fetch(`/questions/${qid}/autosave`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(serializePayload()),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          setStatus(`Save error: ${data.error || res.statusText}`, "warn");
          return;
        }
        setStatus("Saved", "good");
      }

      function scheduleAutosave() {
        setStatus("Unsaved changes", "warn");
        if (autosaveTimer) clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(() => {
          autosaveNow().catch((err) => setStatus(`Save error: ${err.message}`, "warn"));
        }, 1500);
      }

      function renderFigures(scrollToEnd = false) {
        const figures = JSON.parse(figuresInput.value || "[]");
        figuresPreview.innerHTML = "";
        for (let i = 0; i < figures.length; i++) {
          const f = figures[i];
          const card = document.createElement("div");
          card.className = "figure-card";
          const img = document.createElement("img");
          img.className = "thumb";
          img.alt = f.caption || f.id;
          img.src = `data:${f.mime_type};base64,${f.data_base64}`;
          img.style.cursor = "zoom-in";
          img.addEventListener("click", () => {
            imageModalImg.src = img.src;
            imageModal.style.display = "flex";
          });
          const del = document.createElement("button");
          del.type = "button";
          del.textContent = `Delete ${f.id}`;
          del.className = "btn";
          del.addEventListener("click", () => {
            pushUndo("figures", figuresInput.value);
            const next = JSON.parse(figuresInput.value || "[]");
            next.splice(i, 1);
            figuresInput.value = JSON.stringify(next);
            renderFigures();
            scheduleAutosave();
          });
          card.appendChild(img);
          card.appendChild(del);
          figuresPreview.appendChild(card);
        }
        if (scrollToEnd) {
          document.getElementById("figures_section").scrollIntoView({ behavior: "smooth", block: "end" });
        }
      }

      async function sha256FromBytes(bytes) {
        const hash = await crypto.subtle.digest("SHA-256", bytes);
        return Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, "0")).join("");
      }

      async function pasteImageToFigures(file) {
        const arrayBuffer = await file.arrayBuffer();
        const bytes = new Uint8Array(arrayBuffer);
        let binary = "";
        for (const b of bytes) binary += String.fromCharCode(b);
        const dataBase64 = btoa(binary);
        const hash = await sha256FromBytes(bytes);
        pushUndo("figures", figuresInput.value);
        const figures = JSON.parse(figuresInput.value || "[]");
        figures.push({
          id: `fig_${figures.length + 1}`,
          mime_type: file.type || "image/png",
          data_base64: dataBase64,
          sha256: hash,
          caption: ""
        });
        figuresInput.value = JSON.stringify(figures);
        renderFigures(true);
        setStatus("Image pasted", "good");
        scheduleAutosave();
      }

      async function aiApply(btn, endpoint, applyFn) {
        const qid = questionIdEl.value.trim();
        if (!qid) {
          setStatus("Set question ID before AI actions.", "warn");
          return;
        }
        btn.disabled = true;
        setStatus("Calling AI...", "warn");
        try {
          await autosaveNow();
          const res = await fetch(`/questions/${qid}${endpoint}`, { method: "POST" });
          const data = await res.json();
          if (!res.ok || !data.ok) {
            throw new Error(data.error || res.statusText);
          }
          applyFn(data);
          setStatus("AI update applied", "good");
          scheduleAutosave();
        } catch (err) {
          setStatus(`AI error: ${err.message}`, "warn");
        } finally {
          btn.disabled = false;
        }
      }

      async function previewAiPrompt(action, label) {
        const qid = questionIdEl.value.trim();
        if (!qid) {
          setStatus("Set question ID before AI actions.", "warn");
          return;
        }
        setStatus("Loading prompt preview...", "warn");
        try {
          await autosaveNow();
          const res = await fetch(`/questions/${qid}/ai/preview/${action}`, { method: "POST" });
          const data = await res.json();
          if (!res.ok || !data.ok) {
            throw new Error(data.error || res.statusText);
          }
          promptPreviewTitle.textContent = `${label} Prompt Preview`;
          promptPreviewSystem.textContent = data.system_prompt || "";
          promptPreviewUser.textContent = data.user_prompt || "";
          const figs = data.figure_placeholders || [];
          promptPreviewFigures.textContent = figs.length ? figs.join("\n") : "(none)";
          promptPreviewModal.style.display = "flex";
          setStatus("Prompt preview ready", "good");
        } catch (err) {
          setStatus(`Preview error: ${err.message}`, "warn");
        }
      }

      document.addEventListener("paste", async (event) => {
        const items = event.clipboardData?.items || [];
        for (const item of items) {
          if (item.type.startsWith("image/")) {
            const file = item.getAsFile();
            if (file) {
              event.preventDefault();
              await pasteImageToFigures(file);
              return;
            }
          }
        }
        const pasted = event.clipboardData?.getData("text/plain");
        if (pasted) {
          const normalized = scientificNotationNormalize(pasted);
          if (normalized !== pasted) {
            const active = document.activeElement;
            if (active && (active.tagName === "TEXTAREA" || active.tagName === "INPUT")) {
              event.preventDefault();
              const start = active.selectionStart || 0;
              const end = active.selectionEnd || 0;
              active.value = active.value.slice(0, start) + normalized + active.value.slice(end);
              if (active === promptEl) renderMarkdown();
              if (active === solutionEl) renderMarkdown();
              scheduleAutosave();
            }
          }
        }
      });

      document.getElementById("btn_ai_title").addEventListener("click", async (e) => {
        pushUndo("title", titleEl.value);
        await aiApply(e.target, "/ai/suggest-title", (data) => { titleEl.value = data.title || ""; });
      });
      document.getElementById("btn_preview_title").addEventListener("click", () => previewAiPrompt("suggest-title", "Generate Title"));
      document.getElementById("btn_ai_prompt").addEventListener("click", async (e) => {
        pushUndo("prompt", promptEl.value);
        await aiApply(e.target, "/ai/improve-prompt", (data) => { promptEl.value = data.prompt_md || ""; renderMarkdown(); });
      });
      document.getElementById("btn_preview_prompt").addEventListener("click", () => previewAiPrompt("improve-prompt", "Improve Text"));
      document.getElementById("btn_ai_solution").addEventListener("click", async (e) => {
        pushUndo("solution", solutionEl.value);
        await aiApply(e.target, "/ai/draft-solution", (data) => { solutionEl.value = data.solution_md || ""; renderMarkdown(); });
      });
      document.getElementById("btn_preview_solution").addEventListener("click", () => previewAiPrompt("draft-solution", "Improve Solution"));
      document.getElementById("btn_ai_mc").addEventListener("click", async (e) => {
        pushUndo("choices", choicesEl.value);
        pushUndo("solution", solutionEl.value);
        await aiApply(e.target, "/ai/distractors", (data) => {
          choicesEl.value = data.choices_yaml || "";
          solutionEl.value = data.solution_md || solutionEl.value;
          renderMarkdown();
          renderMCPreviews();
        });
      });
      document.getElementById("btn_preview_mc").addEventListener("click", () => previewAiPrompt("distractors", "Generate MC"));

      document.getElementById("btn_undo_title").addEventListener("click", () => undo("title", (v) => { titleEl.value = v; }));
      document.getElementById("btn_undo_prompt").addEventListener("click", () => undo("prompt", (v) => { promptEl.value = v; renderMarkdown(); }));
      document.getElementById("btn_undo_solution").addEventListener("click", () => undo("solution", (v) => { solutionEl.value = v; renderMarkdown(); }));
      document.getElementById("btn_undo_choices").addEventListener("click", () => undo("choices", (v) => { choicesEl.value = v; }));
      document.getElementById("btn_undo_figures").addEventListener("click", () => undo("figures", (v) => { figuresInput.value = v; renderFigures(); }));

      [questionTypeEl, titleEl, promptEl, mcGuidanceEl, choicesEl, solutionEl, checkerEl, pointsEl].forEach((el) => {
        el.addEventListener("input", () => { renderMarkdown(); updateMCVisibility(); renderMCPreviews(); scheduleAutosave(); });
        el.addEventListener("change", () => { renderMarkdown(); updateMCVisibility(); renderMCPreviews(); scheduleAutosave(); });
      });

      imageModal.addEventListener("click", () => {
        imageModal.style.display = "none";
        imageModalImg.src = "";
      });
      document.getElementById("btn_close_prompt_preview").addEventListener("click", () => {
        promptPreviewModal.style.display = "none";
      });
      promptPreviewModal.addEventListener("click", (event) => {
        if (event.target === promptPreviewModal) {
          promptPreviewModal.style.display = "none";
        }
      });

      window.addEventListener("beforeunload", (event) => {
        if (saveStatus.textContent.includes("Unsaved")) {
          event.preventDefault();
          event.returnValue = "";
        }
      });

      renderMarkdown();
      updateMCVisibility();
      renderMCPreviews();
      renderFigures();
      setStatus("Ready", "good");
    </script>
  </body>
</html>
