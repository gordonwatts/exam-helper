<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Question Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
      body { font-family: "Segoe UI", Arial, sans-serif; margin: 1.2rem; }
      form { max-width: 1300px; }
      label { display: block; margin-top: 0.8rem; font-weight: 600; }
      input, textarea, select { width: 100%; box-sizing: border-box; padding: 0.5rem; }
      textarea { min-height: 120px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.8rem; }
      .card { border: 1px solid #ddd; border-radius: 6px; padding: 0.8rem; margin-top: 0.8rem; }
      .preview { background: #fafafa; max-height: 360px; overflow: auto; }
      .status { margin-top: 0.5rem; min-height: 1.2rem; font-size: 0.95rem; }
      .good { color: #0a6; }
      .warn { color: #c50; }
      .btn { padding: 0.45rem 0.8rem; margin-top: 0.45rem; margin-right: 0.45rem; }
      .actions { margin-top: 1rem; }
      @media (max-width: 900px) {
        .row, .row3 { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <h1>{{ "Edit Question" if question else "New Question" }}</h1>
    <p><a href="/">Back to list</a></p>

    <form method="post" action="/questions/save" id="question-form">
      <input type="hidden" name="typed_solution_status" id="typed_solution_status" value="{{ question.solution.typed_solution_status if question else 'missing' }}" />
      <div class="row3">
        <div>
          <label>Question ID</label>
          <input name="question_id" id="question_id" value="{{ question.id if question else '' }}" required />
        </div>
        <div>
          <label>Type</label>
          <select name="question_type" id="question_type">
            <option value="free_response" {% if question and question.question_type.value=="free_response" %}selected{% endif %}>Free Response</option>
            <option value="multiple_choice" {% if question and question.question_type.value=="multiple_choice" %}selected{% endif %}>Multiple Choice</option>
          </select>
        </div>
        <div>
          <label>Points</label>
          <input name="points" id="points" type="number" min="0" value="{{ question.points if question else 5 }}" />
        </div>
      </div>

      <label>Title (optional)</label>
      <input name="title" id="title" value="{{ question.title if question else '' }}" />

      <div class="row">
        <div class="card">
          <label>Question Template (Markdown)</label>
          <textarea name="question_template_md" id="question_template_md">{{ question.solution.question_template_md if question else '' }}</textarea>
          <button type="button" class="btn" id="btn_rewrite">Rewrite + Extract Parameters</button>
          <button type="button" class="btn" id="btn_preview_rewrite">Preview Prompt</button>
        </div>
        <div class="card preview">
          <strong>Rendered Question (from template + params)</strong>
          <div id="prompt_preview"></div>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <label>Rendered Prompt (saved)</label>
          <textarea name="prompt_md" id="prompt_md">{{ question.prompt_md if question else '' }}</textarea>
          <div class="status">This updates automatically from template + parameters and is what gets exported.</div>
        </div>
        <div class="card">
          <label>Parameters (YAML mapping)</label>
          <textarea name="solution_parameters_yaml" id="solution_parameters_yaml">{{ solution_parameters_yaml }}</textarea>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <label>Answer Function Python (`solve(params)`)</label>
          <textarea name="answer_python_code" id="answer_python_code">{{ question.solution.answer_python_code if question else '' }}</textarea>
          <button type="button" class="btn" id="btn_generate_answer">Generate Answer Function</button>
          <button type="button" class="btn" id="btn_run_harness">Run Deterministic Harness</button>
          <button type="button" class="btn" id="btn_preview_answer">Preview Prompt</button>
        </div>
        <div class="card preview">
          <strong>Computed Answer</strong>
          <div id="computed_answer_preview">{{ question.solution.last_computed_answer_md if question else '' }}</div>
        </div>
      </div>

      <div id="mc_block" class="card">
        <label>Distractor Functions YAML (4 entries)</label>
        <textarea name="distractor_functions_yaml" id="distractor_functions_yaml">{{ distractor_functions_yaml }}</textarea>
        <button type="button" class="btn" id="btn_generate_mc">Generate MC Choices</button>
        <button type="button" class="btn" id="btn_preview_mc">Preview Prompt</button>
        <label>MC Choices YAML (A-E)</label>
        <textarea name="choices_yaml" id="choices_yaml">{{ choices_yaml }}</textarea>
        <div class="card preview">
          <strong>MC Preview</strong>
          <div id="mc_preview_answers"></div>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <label>Typed Solution (LLM-generated on demand)</label>
          <textarea name="typed_solution_md" id="typed_solution_md">{{ question.solution.typed_solution_md if question else '' }}</textarea>
          <button type="button" class="btn" id="btn_generate_typed_solution">Generate/Regenerate Typed Solution</button>
          <button type="button" class="btn" id="btn_preview_typed_solution">Preview Prompt</button>
          <div class="status" id="typed_solution_state">Status: {{ question.solution.typed_solution_status if question else "missing" }}</div>
        </div>
        <div class="card preview">
          <strong>Typed Solution Preview</strong>
          <div id="typed_solution_preview"></div>
        </div>
      </div>

      <div class="card" id="figures_section">
        <label>Figures (embedded)</label>
        <input type="hidden" id="figures_json" name="figures_json" value='{{ figures_json }}' />
        <div id="figures_preview"></div>
      </div>

      <div class="actions">
        <button type="submit" class="btn">Save and Return</button>
        <span id="save_status" class="status"></span>
      </div>
    </form>

    <script>
      const form = document.getElementById("question-form");
      const saveStatus = document.getElementById("save_status");
      const questionIdEl = document.getElementById("question_id");
      const questionTypeEl = document.getElementById("question_type");
      const titleEl = document.getElementById("title");
      const pointsEl = document.getElementById("points");
      const templateEl = document.getElementById("question_template_md");
      const promptEl = document.getElementById("prompt_md");
      const paramsEl = document.getElementById("solution_parameters_yaml");
      const answerCodeEl = document.getElementById("answer_python_code");
      const distractorFnsEl = document.getElementById("distractor_functions_yaml");
      const choicesEl = document.getElementById("choices_yaml");
      const typedSolutionEl = document.getElementById("typed_solution_md");
      const typedStatusEl = document.getElementById("typed_solution_status");
      const typedStateLabelEl = document.getElementById("typed_solution_state");
      const figuresInput = document.getElementById("figures_json");
      const promptPreview = document.getElementById("prompt_preview");
      const computedAnswerPreview = document.getElementById("computed_answer_preview");
      const mcBlock = document.getElementById("mc_block");
      const mcPreviewAnswers = document.getElementById("mc_preview_answers");
      const typedPreview = document.getElementById("typed_solution_preview");

      let autosaveTimer = null;

      function setStatus(text, cls) {
        saveStatus.textContent = text;
        saveStatus.className = `status ${cls || ""}`;
      }

      function isMC() {
        return questionTypeEl.value === "multiple_choice";
      }

      function setTypedStatus(status) {
        typedStatusEl.value = status;
        typedStateLabelEl.textContent = `Status: ${status}`;
      }

      function renderTemplate() {
        let params = {};
        try {
          params = jsyaml.load(paramsEl.value || "{}") || {};
        } catch {
          params = {};
        }
        let out = templateEl.value || "";
        for (const [k, v] of Object.entries(params)) {
          out = out.split("{{" + k + "}}").join(String(v));
        }
        promptEl.value = out;
        promptPreview.innerHTML = marked.parse(out || "");
      }

      function renderMCPreview() {
        if (!isMC()) {
          mcPreviewAnswers.innerHTML = "";
          return;
        }
        let choices = [];
        try {
          choices = jsyaml.load(choicesEl.value || "[]") || [];
        } catch {
          mcPreviewAnswers.innerHTML = "<em>Invalid YAML</em>";
          return;
        }
        choices = choices.slice().sort((a, b) => String(a.label || "").localeCompare(String(b.label || "")));
        mcPreviewAnswers.innerHTML = choices.map((c) => {
          const text = marked.parseInline(String(c.content_md || ""));
          const marker = c.is_correct ? " <strong>(correct)</strong>" : "";
          const rationale = c.rationale ? `<div><em>${String(c.rationale)}</em></div>` : "";
          return `<div><strong>${String(c.label || "?")}.</strong> ${text}${marker}${rationale}</div>`;
        }).join("");
      }

      function renderTypedPreview() {
        typedPreview.innerHTML = marked.parse(typedSolutionEl.value || "");
      }

      function updateMCVisibility() {
        mcBlock.style.display = isMC() ? "block" : "none";
      }

      function serializePayload() {
        return {
          title: titleEl.value,
          question_type: questionTypeEl.value,
          prompt_md: promptEl.value,
          question_template_md: templateEl.value,
          solution_parameters_yaml: paramsEl.value,
          answer_python_code: answerCodeEl.value,
          distractor_functions_yaml: distractorFnsEl.value,
          choices_yaml: choicesEl.value,
          typed_solution_md: typedSolutionEl.value,
          typed_solution_status: typedStatusEl.value,
          figures_json: figuresInput.value || "[]",
          points: Number(pointsEl.value || 5),
        };
      }

      async function autosaveNow() {
        const qid = questionIdEl.value.trim();
        if (!qid) return;
        setStatus("Saving...", "warn");
        const res = await fetch(`/questions/${qid}/autosave`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(serializePayload()),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          setStatus(`Save error: ${data.error || res.statusText}`, "warn");
          return;
        }
        if (data.typed_solution_status) setTypedStatus(data.typed_solution_status);
        setStatus("Saved", "good");
      }

      function scheduleAutosave() {
        setStatus("Unsaved changes", "warn");
        if (autosaveTimer) clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(() => {
          autosaveNow().catch((err) => setStatus(`Save error: ${err.message}`, "warn"));
        }, 1200);
      }

      async function callEndpoint(endpoint, applyFn) {
        const qid = questionIdEl.value.trim();
        if (!qid) {
          setStatus("Set question ID first.", "warn");
          return;
        }
        await autosaveNow();
        const res = await fetch(`/questions/${qid}${endpoint}`, { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          const collisions = data.collisions ? ` ${data.collisions.join(" | ")}` : "";
          throw new Error((data.error || res.statusText) + collisions);
        }
        applyFn(data);
        scheduleAutosave();
      }

      document.getElementById("btn_rewrite").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/rewrite-and-parameterize", (data) => {
            if (data.title && !titleEl.value.trim()) titleEl.value = data.title;
            templateEl.value = data.question_template_md || templateEl.value;
            paramsEl.value = data.solution_parameters_yaml || paramsEl.value;
            promptEl.value = data.prompt_md || promptEl.value;
            renderTemplate();
            setTypedStatus("stale");
          });
          setStatus("Rewrite + parameter extraction complete.", "good");
        } catch (err) {
          setStatus(`AI error: ${err.message}`, "warn");
        }
      });

      document.getElementById("btn_generate_answer").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/generate-answer-function", (data) => {
            answerCodeEl.value = data.answer_python_code || "";
            setTypedStatus("stale");
          });
          setStatus("Answer function generated.", "good");
        } catch (err) {
          setStatus(`AI error: ${err.message}`, "warn");
        }
      });

      document.getElementById("btn_run_harness").addEventListener("click", async () => {
        try {
          await callEndpoint("/harness/run", (data) => {
            computedAnswerPreview.innerHTML = marked.parse(data.computed_answer_md || "");
            if (data.choices_yaml) choicesEl.value = data.choices_yaml;
            renderMCPreview();
          });
          setStatus("Harness run complete.", "good");
        } catch (err) {
          setStatus(`Harness error: ${err.message}`, "warn");
        }
      });

      document.getElementById("btn_generate_mc").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/generate-mc-distractors", (data) => {
            distractorFnsEl.value = data.distractor_functions_yaml || distractorFnsEl.value;
            choicesEl.value = data.choices_yaml || choicesEl.value;
            renderMCPreview();
            setTypedStatus("stale");
          });
          setStatus("MC distractors generated with unique options.", "good");
        } catch (err) {
          setStatus(`MC generation error: ${err.message}`, "warn");
        }
      });

      document.getElementById("btn_generate_typed_solution").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/generate-typed-solution", (data) => {
            typedSolutionEl.value = data.typed_solution_md || "";
            renderTypedPreview();
            setTypedStatus(data.typed_solution_status || "fresh");
          });
          setStatus("Typed solution generated.", "good");
        } catch (err) {
          setStatus(`AI error: ${err.message}`, "warn");
        }
      });

      document.getElementById("btn_preview_rewrite").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/preview/rewrite-and-parameterize", (data) => {
            alert(`System prompt:\n\n${data.system_prompt}\n\nUser prompt:\n\n${data.user_prompt}`);
          });
        } catch (err) {
          setStatus(`Preview error: ${err.message}`, "warn");
        }
      });
      document.getElementById("btn_preview_answer").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/preview/generate-answer-function", (data) => {
            alert(`System prompt:\n\n${data.system_prompt}\n\nUser prompt:\n\n${data.user_prompt}`);
          });
        } catch (err) {
          setStatus(`Preview error: ${err.message}`, "warn");
        }
      });
      document.getElementById("btn_preview_mc").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/preview/generate-mc-distractors", (data) => {
            alert(`System prompt:\n\n${data.system_prompt}\n\nUser prompt:\n\n${data.user_prompt}`);
          });
        } catch (err) {
          setStatus(`Preview error: ${err.message}`, "warn");
        }
      });
      document.getElementById("btn_preview_typed_solution").addEventListener("click", async () => {
        try {
          await callEndpoint("/ai/preview/generate-typed-solution", (data) => {
            alert(`System prompt:\n\n${data.system_prompt}\n\nUser prompt:\n\n${data.user_prompt}`);
          });
        } catch (err) {
          setStatus(`Preview error: ${err.message}`, "warn");
        }
      });

      [questionTypeEl, titleEl, templateEl, promptEl, paramsEl, answerCodeEl, distractorFnsEl, choicesEl, typedSolutionEl, pointsEl].forEach((el) => {
        el.addEventListener("input", () => {
          renderTemplate();
          renderMCPreview();
          renderTypedPreview();
          if (el === paramsEl || el === answerCodeEl || el === distractorFnsEl) setTypedStatus("stale");
          updateMCVisibility();
          scheduleAutosave();
        });
      });

      renderTemplate();
      renderMCPreview();
      renderTypedPreview();
      updateMCVisibility();
      setStatus("Ready", "good");
    </script>
  </body>
</html>
